dist: xenial
sudo: false
language: java
env:
- BUILD_DIR="~/builds/backend-test/"
before_install:
- openssl aes-256-cbc -K $encrypted_c28ab4f155ee_key -iv $encrypted_c28ab4f155ee_iv
  -in id_rsa-travis-ci.enc -out id_rsa -d
- eval "$(ssh-agent -s)"
- chmod 600 ./id_rsa
- ssh-add ~/.ssh/id_rsa
- echo -e "Host jak.cherement.nl\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
- echo $BUILD_DIR
- ssh -i ./id_rsa travis-ci@jak.cherement.nl pwd
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
services:
- docker
jobs:
  include:
  - stage: Tests
    script: ./gradlew test
  - stage: Deployment-Test.server
    script:
    - rsync -au -e "ssh -i ./id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" --progress build/libs/*.jar travis-ci@jak.cherement.nl:$BUILD_DIR\app.jar
    - rsync -au -e "ssh -i ./id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" --progress Dockerfile travis-ci@jak.cherement.nl:$BUILD_DIR\Dockerfile
    - ssh -i ./id_rsa travis-ci@jak.cherement.nl $BUILD_DIR\rebuild-docker.sh

  - stage: Deployment-prod.server
    env:
      - BUILD_DIR="~/builds/backend-prod/"
    script:
    - rsync -au -e "ssh -i ./id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" --progress build/libs/*.jar travis-ci@jak.cherement.nl:$BUILD_DIR\app.jar
    - rsync -au -e "ssh -i ./id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" --progress Dockerfile travis-ci@jak.cherement.nl:$BUILD_DIR\Dockerfile
    - ssh -i ./id_rsa travis-ci@jak.cherement.nl $BUILD_DIR\rebuild-docker.sh


